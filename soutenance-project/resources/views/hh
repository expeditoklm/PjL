<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use App\Models\User;
use App\Models\Personne;

class AuthController extends Controller
{
    public function authenticate(Request $request)
    {
        // Récupérer les informations de connexion de la requête
        $credentials = $request->only('email', 'password');
        $type = $request->input('type'); // Type de personne

        // Authentifier l'utilisateur avec les informations fournies
        if (Auth::attempt($credentials)) {
            // Récupérer l'utilisateur authentifié
            $user = Auth::user();

            // Récupérer l'identifiant de la personne associée à l'utilisateur
            $personne_id = $user->personne_id;

            // Vérifier le type de personne et rediriger en conséquence
            if ($type === 'Patient') {
                // Vérifier si l'identifiant de la personne est présent dans la table Patient
                if (Personne::where('id', $personne_id)->exists()) {
                    // Rediriger l'utilisateur vers la page d'accueil
                    return redirect()->route('home');
                }
            } elseif ($type === 'Personnel de santé') {
                // Vérifier si l'identifiant de la personne est présent dans la table PersonnelSante
                if (PersonnelSante::where('id', $personne_id)->exists()) {
                    // Rediriger l'utilisateur vers la page d'accueil
                    return redirect()->route('home');
                }
            }
        }

        // Si l'authentification échoue ou si aucune correspondance n'est trouvée, rediriger vers la page de connexion avec un message d'erreur
        return redirect('login')->with('error', 'Identifiants incorrects');
    }
}























/*public function login(Request $request)
    {
        /*
        lorsque l'utilisateur  entre son email et son mots de passe avec le type de personne quil est ,
        je verifie si jai ce utilisateur dans ma table users ,
        si oui ,je recupere l' identifant dans la table personne qui correspond a lidentifiant de lutilisateur dans la table users ,
        je verifie si lidentifiant recuperer dans la table personnes correspond a un identifiant de la table patient si entre temps l'utilisateur avait 
        specifier que le type de personne est paitent ou dans la table personnelsante si entre temps le type de personne etait  personnel de sante.
        s'il y a  correspondance dans lune de ces table avec la table personne .rediriger lutilisateur  vers la page daccueil.
        */
        
        $credentials = $request->only('email', 'password');
        $type = $request->input('type'); // Type de personnel
        $personne = Personne::where('user_id', $request->email)->first();

        // Vérification de l'authentification pour le personnel de santé
        if ($type === 'Personnel de santé') {
            $personnelSante = PersonnelSante::where('email', $request->email)->first();
            if ($personnelSante && Hash::check($request->password, $personnelSante->password)) {
                Auth::login($personnelSante);
                return redirect()->intended('dashboard');
            }
        } 
        // Vérification de l'authentification pour les patients
        elseif ($type === 'Patient') {
            $patient = Patient::where('email', $request->email)->first();
            if ($patient && Hash::check($request->password, $patient->password)) {
                Auth::login($patient);
                return redirect()->intended('dashboard');
            }
        }

        return redirect('login')->with('error', 'Identifiants incorrects');
    }
*/
















/*
        lorsque l'utilisateur  entre son email et son mots de passe avec le type de personne quil est ,
        je verifie si jai ce utilisateur dans ma table users ,
        si oui ,je recupere l' identifant dans la table personne qui correspond a lidentifiant de lutilisateur dans la table users ,
        je verifie si lidentifiant recuperer dans la table personnes correspond a un identifiant de la table patient si entre temps l'utilisateur avait 
        specifier que le type de personne est paitent ou dans la table personnelsante si entre temps le type de personne etait  personnel de sante.
        s'il y a  correspondance dans lune de ces table avec la table personne .rediriger lutilisateur  vers la page daccueil.
       

        lorsque lutilisateur est un personnel de sante je recupere ,son type de personnel de sante soit 
        medecin,infirmier,technicien labo et son numero identifiant personnelSante ,
        que je compare a son type tersonnelSante et son numero qui est dans la table Personnelsante.
        je recupere aussi  lidentifiant  de lhopital dintervention du personnel de sante
          que jutilise pour verifier si lid de lhopital correspond aux id des hopitaux 
          dinterventien du personnel de sante en Question
          dans la table relation entre personnelSante et hopital intitulé personnelSante_hopital

        */


        public function __construct()
{
    // Ce constructeur définit un middleware pour ce contrôleur.
    // Les middlewares sont des filtres qui s'exécutent avant et/ou après les requêtes HTTP.
    // Dans ce cas, le middleware 'guest' est appliqué à toutes les méthodes de ce contrôleur,
    // sauf la méthode 'logout'.
    // Le middleware 'guest' vérifie si l'utilisateur est authentifié. S'il l'est, il redirige
    // automatiquement l'utilisateur vers la page spécifiée dans la configuration 'redirectTo'.
    // Si l'utilisateur n'est pas authentifié, il lui permet de continuer à accéder à la méthode
    // du contrôleur.

    // Donc, pour résumer, ce constructeur garantit que seuls les utilisateurs non authentifiés
    // peuvent accéder aux méthodes de ce contrôleur, à l'exception de la méthode 'logout',
    // qui permet à l'utilisateur de se déconnecter.

    $this->middleware('guest')->except('logout');
}







        elseif ($user->typePersonne === 'Patient') {
            // Vérification de l'authentification pour les patients
            if (Auth::attempt($credentials)) {
                $patient = $user->personne->patients->first();
                if ($patient) {
                    return redirect()->intended('home');
                }
            }
        }